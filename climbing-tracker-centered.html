<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Day Climbing Training Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 2.2em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .tab-button {
            padding: 12px 24px;
            background: #ecf0f1;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            color: #7f8c8d;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .input-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3498db;
        }
        
        .input-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #34495e;
            font-weight: 500;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .recommendation-panel {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 15px 0;
        }
        
        .recommendation-panel h2 {
            font-size: 1.6em;
            margin-bottom: 10px;
        }
        
        .recommendation-text {
            font-size: 1.1em;
            margin-bottom: 15px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .weekly-chart {
            grid-column: 1 / -1;
            height: 400px;
        }
        
        .no-data-message {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #7f8c8d;
            font-size: 18px;
            padding: 20px;
        }
        
        .update-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s ease;
            margin-right: 10px;
        }
        
        .update-btn:hover {
            transform: translateY(-2px);
        }
        
        .log-entry {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3498db;
        }
        
        .log-date {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .log-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 14px;
        }
        
        .log-metric {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 5px;
        }
        
        .log-recommendation {
            margin-top: 10px;
            padding: 10px;
            background: #e8f4f8;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .date-selector {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .date-selector input[type="date"] {
            width: auto;
            min-width: 150px;
        }
        
        .export-section {
            text-align: center;
            margin-top: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .delete-btn:hover {
            background: #c0392b;
            transform: scale(1.05);
        }
        
        .export-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            margin: 0 5px;
        }
        
        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 450px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-content h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .modal-content p {
            margin-bottom: 25px;
            color: #34495e;
            font-size: 1.1em;
            line-height: 1.6;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        
        .modal-btn-confirm {
            background: #e74c3c;
            color: white;
        }
        
        .modal-btn-confirm:hover {
            background: #c0392b;
        }
        
        .modal-btn-cancel {
            background: #ecf0f1;
            color: #7f8c8d;
        }
        
        .modal-btn-cancel:hover {
            background: #bdc3c7;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ§— Multi-Day Climbing Training Tracker</h1>
        
        <div class="nav-tabs">
            <button class="tab-button active" onclick="app.switchTab('daily')">Daily Entry</button>
            <button class="tab-button" onclick="app.switchTab('history')">Training History</button>
            <button class="tab-button" onclick="app.switchTab('analytics')">Analytics</button>
        </div>
        
        <div id="daily" class="tab-content active">
            <div class="date-selector">
                <label for="currentDate">Date:</label>
                <input type="date" id="currentDate">
                <button class="update-btn" onclick="app.loadDataForDate()">Load Date</button>
            </div>
            
            <div class="dashboard">
                <div class="input-section">
                    <h3>Recovery Metrics</h3>
                    <div class="input-group">
                        <label>Sleep Quality (1-10)</label>
                        <input type="number" id="sleepQuality" min="1" max="10" value="" step="0.5" placeholder="1-10" oninput="validateNumericInput(this, 1, 10)" onkeypress="return isNumberKey(event)">
                    </div>
                    <div class="input-group">
                        <label>Sleep Duration (hours)</label>
                        <input type="number" id="sleepDuration" min="3" max="12" value="" step="0.5" placeholder="3-12" oninput="validateNumericInput(this, 3, 12)" onkeypress="return isNumberKey(event)">
                    </div>
                    <div class="input-group">
                        <label>Mood State</label>
                        <select id="mood">
                            <option value="">Select mood...</option>
                            <option value="1">Psyched</option>
                            <option value="2">Optimistic</option>
                            <option value="3">Focused</option>
                            <option value="4">Ready</option>
                            <option value="5">Composed</option>
                            <option value="6">Neutral</option>
                            <option value="7">Apathetic</option>
                            <option value="8">Frustrated</option>
                            <option value="9">Lethargic</option>
                            <option value="10">Exhausted</option>
                        </select>
                    </div>
                </div>
                
                <div class="input-section">
                    <h3>Physical State</h3>
                    <div class="input-group">
                        <label>Stress Level (1-10)</label>
                        <input type="number" id="stress" min="1" max="10" value="" step="1" placeholder="1-10" oninput="validateNumericInput(this, 1, 10)" onkeypress="return isNumberKey(event)">
                    </div>
                    <div class="input-group">
                        <label>Muscle Soreness (DOMS)</label>
                        <select id="doms">
                            <option value="">Select condition...</option>
                            <option value="1">Absent</option>
                            <option value="2">Noticeable</option>
                            <option value="3">Slightly Stiff</option>
                            <option value="4">Mild Ache</option>
                            <option value="5">Noticeable Ache</option>
                            <option value="6">Moderate Discomfort</option>
                            <option value="7">Significant Pain</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Tendon Condition</label>
                        <select id="tendons">
                            <option value="">Select condition...</option>
                            <option value="1">Absent</option>
                            <option value="2">Noticeable</option>
                            <option value="3">Highlighted</option>
                            <option value="4">Mild Ache</option>
                            <option value="5">Annoying Ache</option>
                            <option value="6">Moderate Discomfort</option>
                        </select>
                    </div>
                </div>
                
                <div class="input-section">
                    <h3>Training History</h3>
                    <div class="input-group">
                        <label>Days Since Last Session</label>
                        <input type="number" id="daysSince" min="0" max="14" value="" placeholder="0-14" step="1" oninput="validateNumericInput(this, 0, 14)" onkeypress="return isWholeNumberKey(event)">
                    </div>
                    <div class="input-group">
                        <label>Last Session RPE (1-10)</label>
                        <input type="number" id="lastRPE" min="1" max="10" value="" step="0.5" placeholder="1-10" oninput="validateNumericInput(this, 1, 10)" onkeypress="return isNumberKey(event)">
                    </div>
                    <div class="input-group">
                        <label>Skin Condition</label>
                        <select id="skin">
                            <option value="">Select condition...</option>
                            <option value="1">Perfect</option>
                            <option value="1.5">Robust</option>
                            <option value="3">Slightly Worn</option>
                            <option value="4">Tender Spots</option>
                            <option value="5">Sensitive</option>
                            <option value="6">Raw/Burning</option>
                            <option value="7">Edge Tears</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Climbing Type</label>
                        <select id="climbingType">
                            <option value="">Select type...</option>
                            <option value="Bouldering">Bouldering</option>
                            <option value="Top Rope">Top Rope</option>
                            <option value="Lead">Lead</option>
                            <option value="No Training">No Training</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <button class="update-btn" onclick="app.calculateRecommendation()">Update Recommendation</button>
            <button class="update-btn" onclick="app.saveEntry()">Save Entry</button>
            
            <div class="recommendation-panel" id="recommendationPanel">
                <h2 id="recommendationTitle">Tomorrow's Training Recommendation</h2>
                <div class="recommendation-text" id="recommendationText">Enter your metrics above to get a recommendation</div>
                <div class="metrics-grid" id="metricsGrid"></div>
            </div>
        </div>
        
        <div id="history" class="tab-content">
            <div class="export-section">
                <button class="export-btn" onclick="app.exportToCSV()">Export to CSV</button>
                <button class="export-btn" onclick="app.confirmClearAllData()" style="background: #e74c3c;">Clear All Data</button>
            </div>
            <div id="historyList" style="padding: 20px 0;"></div>
        </div>
        
        <div id="analytics" class="tab-content">
            <div class="charts-section">
                <div class="chart-container weekly-chart">
                    <canvas id="weeklyTrendChart"></canvas>
                    <div id="noDataMessage" class="no-data-message" style="display: none;">
                        Not enough data to display a chart.<br>Please add at least one entry.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal HTML -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle">Confirmation</h3>
            <p id="modalMessage">Are you sure?</p>
            <div class="modal-buttons">
                <button id="modalConfirmBtn" class="modal-btn modal-btn-confirm">Confirm</button>
                <button id="modalCancelBtn" class="modal-btn modal-btn-cancel">Cancel</button>
            </div>
        </div>
    </div>


    <script>
        class MultiDayTracker {
            constructor() {
                this.trainingData = this.loadData();
                this.currentDate = new Date().toISOString().split('T')[0];
                document.getElementById('currentDate').value = this.currentDate;
                this.weeklyChart = null;

                // Initialize UI
                this.updateHistory();
                this.loadDataForDate();
            }
            
            // --- SCORING ALGORITHMS ---
            recoveryDecay(days, halfLife = 2.5) { return 1 - Math.exp(-days * Math.log(2) / halfLife); }
            stressImpact(stress) { return 10 / (1 + Math.exp(-0.8 * (stress - 5))); }
            cumulativeFatigue(rpe, days) { return Math.log(1 + rpe) * Math.exp(-days / 3); }
            
            calculateAdvancedReadiness(inputs) {
                const {sleepQuality, sleepDuration, mood, stress, doms, tendons, daysSince, lastRPE, skin} = inputs;
                if ([sleepQuality, sleepDuration, mood, stress, doms, tendons, daysSince, lastRPE, skin].some(val => val === '' || isNaN(val))) {
                    return null;
                }
                const sleepOptimal = sleepDuration >= 7 && sleepDuration <= 9 ? 1 : Math.exp(-Math.pow((sleepDuration - 8) / 2, 2));
                const sleepScore = (sleepQuality / 10) * sleepOptimal;
                const recoveryScore = this.recoveryDecay(daysSince);
                const stressScore = 1 - (this.stressImpact(stress) / 10);
                const physicalScore = Math.exp(-((doms - 1) + (tendons - 1)) / 5);
                const fatigueScore = 1 - this.cumulativeFatigue(lastRPE, daysSince);
                const moodScore = Math.pow((11 - mood) / 10, 1.5);
                const skinScore = skin <= 3 ? 1 : skin <= 5 ? 0.7 : skin <= 7 ? 0.4 : 0.1;
                
                const baseReadiness = (
                    sleepScore * 0.25 + recoveryScore * 0.20 + stressScore * 0.15 + 
                    physicalScore * 0.20 + fatigueScore * 0.10 + moodScore * 0.10
                ) * skinScore;
                
                const interactionMultiplier = this.calculateInteractions(inputs);
                return Math.max(0, Math.min(10, baseReadiness * 10 * interactionMultiplier));
            }
            
            calculateInteractions(inputs) {
                const {sleepQuality, stress, doms, tendons, daysSince} = inputs;
                const sleepStressBonus = sleepQuality > 7 && stress < 4 ? 1.15 : 1.0;
                const recoveryPainPenalty = (doms > 4 || tendons > 4) && daysSince < 2 ? 0.8 : 1.0;
                const compoundStress = stress > 6 && (doms > 5 || tendons > 5) ? 0.7 : 1.0;
                return sleepStressBonus * recoveryPainPenalty * compoundStress;
            }
            
            // --- RECOMMENDATIONS ---
            generateRecommendation(readinessScore, inputs) {
                const riskFactors = this.assessRiskFactors(inputs);
                const trainingVolume = this.calculateOptimalVolume(readinessScore, riskFactors);
                
                if (readinessScore >= 8.5) return { type: "HIGH INTENSITY", description: "Perfect conditions for limit bouldering or project attempts", volume: trainingVolume.high, risk: "LOW", color: "#27ae60" };
                if (readinessScore >= 7) return { type: "MODERATE INTENSITY",  description: "Good for technical climbing and strength training", volume: trainingVolume.moderate, risk: "LOW-MODERATE", color: "#f39c12" };
                if (readinessScore >= 5) return { type: "LIGHT TRAINING", description: "Focus on technique, mobility, or easy volume", volume: trainingVolume.light, risk: "MODERATE", color: "#e67e22" };
                if (readinessScore >= 3) return { type: "RECOVERY FOCUS", description: "Active recovery, stretching, or very light movement", volume: trainingVolume.recovery, risk: "MODERATE-HIGH", color: "#e74c3c" };
                return { type: "REST DAY", description: "Complete rest recommended - address limiting factors", volume: "0 hours", risk: "HIGH", color: "#c0392b" };
            }
            
            assessRiskFactors(inputs) {
                 const risks = [];
                if (inputs.tendons > 4) risks.push("Tendon strain risk");
                if (inputs.doms > 5) risks.push("Muscle overload risk");
                if (inputs.stress > 7) risks.push("Psychological stress");
                if (inputs.sleepQuality < 6) risks.push("Insufficient recovery");
                if (inputs.skin > 5) risks.push("Skin injury risk");
                if (inputs.daysSince === 0) risks.push("Insufficient rest");
                return risks;
            }
            
            calculateOptimalVolume(readiness, risks) {
                 const baseVolumes = { high: "2-3 hours", moderate: "1.5-2 hours", light: "1-1.5 hours",  recovery: "30-60 minutes" };
                if (risks.length > 2) return { high: "1.5-2 hours", moderate: "1-1.5 hours", light: "45-90 minutes", recovery: "20-45 minutes" };
                return baseVolumes;
            }

            // --- DATA & UI ---
            saveData() { localStorage.setItem('climbingData', JSON.stringify(this.trainingData)); }
            loadData() { return JSON.parse(localStorage.getItem('climbingData') || '{}'); }
            
            saveEntry() {
                const date = document.getElementById('currentDate').value;
                const inputs = this.getCurrentInputs();
                const readiness = this.calculateAdvancedReadiness(inputs);
                if (readiness === null) {
                    this.showModal("Incomplete Data", "Please fill out all fields before saving.");
                    return;
                }
                const recommendation = this.generateRecommendation(readiness, inputs);
                
                this.trainingData[date] = { ...inputs, readiness, recommendation: recommendation.type, timestamp: new Date().toISOString() };
                this.saveData();
                this.updateHistory();
                this.showModal('Success!', 'Entry saved successfully!');
            }

            deleteEntry(date) {
                this.showModal('Delete Entry?', `Are you sure you want to delete the entry for ${new Date(date + 'T12:00:00').toLocaleDateString()}?`, () => {
                    delete this.trainingData[date];
                    this.saveData();
                    this.updateHistory();
                    this.showModal('Deleted!', 'The entry has been removed.');
                });
            }

            confirmClearAllData() {
                this.showModal('Delete All Data?', 'This will permanently delete all entries. This action cannot be undone.', () => {
                    this.trainingData = {};
                    this.saveData();
                    this.updateHistory();
                    this.showModal('Success!', 'All data has been cleared.');
                });
            }

            exportToCSV() {
                const headers = ['date', 'readiness', 'recommendation', 'sleepQuality', 'sleepDuration', 'mood', 'stress', 'doms', 'tendons', 'daysSince', 'lastRPE', 'skin', 'climbingType'];
                const sortedData = Object.keys(this.trainingData).sort().map(date => ({ date, ...this.trainingData[date] }));

                let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n";
                csvContent += sortedData.map(entry => headers.map(header => `"${entry[header] || ''}"`).join(",")).join("\n");

                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", "climbing_data.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            getCurrentInputs() {
                return {
                    sleepQuality: parseFloat(document.getElementById('sleepQuality').value),
                    sleepDuration: parseFloat(document.getElementById('sleepDuration').value),
                    mood: parseInt(document.getElementById('mood').value),
                    stress: parseInt(document.getElementById('stress').value),
                    doms: parseInt(document.getElementById('doms').value),
                    tendons: parseInt(document.getElementById('tendons').value),
                    daysSince: parseInt(document.getElementById('daysSince').value),
                    lastRPE: parseFloat(document.getElementById('lastRPE').value),
                    skin: parseFloat(document.getElementById('skin').value),
                    climbingType: document.getElementById('climbingType').value
                };
            }
            
            loadDataForDate() {
                const date = document.getElementById('currentDate').value;
                const data = this.trainingData[date];
                const fields = ['sleepQuality', 'sleepDuration', 'mood', 'stress', 'doms', 'tendons', 'daysSince', 'lastRPE', 'skin', 'climbingType'];
                if (data) {
                    fields.forEach(field => document.getElementById(field).value = data[field] || '');
                } else {
                    fields.forEach(field => document.getElementById(field).value = '');
                }
                this.calculateRecommendation();
            }
            
            updateHistory() {
                const historyList = document.getElementById('historyList');
                const sortedDates = Object.keys(this.trainingData).sort((a, b) => new Date(b) - new Date(a));
                
                if (sortedDates.length === 0) {
                    historyList.innerHTML = '<p style="text-align: center; color: #7f8c8d; margin-top: 50px;">No training entries yet!</p>';
                    return;
                }
                
                historyList.innerHTML = sortedDates.map(date => {
                    const entry = this.trainingData[date];
                    const displayDate = new Date(date + 'T12:00:00').toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
                    return `<div class="log-entry">
                                <div class="log-date">
                                    <span>${displayDate}</span>
                                    <button class="delete-btn" onclick="app.deleteEntry('${date}')">âœ• Delete</button>
                                </div>
                                <div class="log-metrics">
                                    <div class="log-metric">Sleep: ${entry.sleepQuality}/10 (${entry.sleepDuration}h)</div>
                                    <div class="log-metric">Mood: ${this.getMoodText(entry.mood)}</div>
                                    <div class="log-metric">Stress: ${entry.stress}/10</div>
                                    <div class="log-metric">DOMS: ${entry.doms}/10</div>
                                    <div class="log-metric">Tendons: ${entry.tendons}/10</div>
                                    <div class="log-metric">Readiness: ${entry.readiness.toFixed(1)}/10</div>
                                    <div class="log-metric">Type: ${entry.climbingType || 'N/A'}</div>
                                </div>
                                <div class="log-recommendation">${entry.recommendation}</div>
                            </div>`;
                }).join('');
            }

            calculateRecommendation() {
                const inputs = this.getCurrentInputs();
                const readiness = this.calculateAdvancedReadiness(inputs);
                const titleEl = document.getElementById('recommendationTitle');
                const textEl = document.getElementById('recommendationText');
                const gridEl = document.getElementById('metricsGrid');

                if (readiness === null) {
                    titleEl.textContent = "Awaiting Input";
                    textEl.textContent = "Please fill out all metrics to generate a recommendation.";
                    gridEl.innerHTML = '';
                    return;
                }

                const rec = this.generateRecommendation(readiness, inputs);
                const riskFactors = this.assessRiskFactors(inputs);

                titleEl.textContent = `Recommendation: ${rec.type}`;
                textEl.textContent = rec.description;
                
                gridEl.innerHTML = `
                    <div class="metric-card" style="border-left: 4px solid ${rec.color};"><div class="metric-value">${readiness.toFixed(1)}</div><span>Readiness Score</span></div>
                    <div class="metric-card"><div class="metric-value">${rec.volume}</div><span>Suggested Volume</span></div>
                    <div class="metric-card"><div class="metric-value">${rec.risk}</div><span>Injury Risk</span></div>
                    ${riskFactors.length > 0 ? `<div class="metric-card" style="grid-column: 1 / -1;"><div class="metric-value" style="font-size: 1.2em; line-height: 1.4;">${riskFactors.join('<br>')}</div><span>Key Risk Factors</span></div>` : ''}
                `;
            }

            // --- TABS & MODAL ---
            switchTab(tabName) {
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.getElementById(tabName).classList.add('active');
                document.querySelector(`.tab-button[onclick*="'${tabName}'"]`).classList.add('active');

                if (tabName === 'analytics') this.createWeeklyTrendChart();
                if (tabName === 'history') this.updateHistory();
            }

            showModal(title, message, onConfirm) {
                const modal = document.getElementById('customModal');
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalMessage').textContent = message;
                modal.classList.add('active');

                const confirmBtn = document.getElementById('modalConfirmBtn');
                const cancelBtn = document.getElementById('modalCancelBtn');

                if (onConfirm) {
                    confirmBtn.style.display = 'inline-block';
                    cancelBtn.textContent = 'Cancel';
                } else { // It's just an info alert
                    confirmBtn.style.display = 'none';
                    cancelBtn.textContent = 'OK';
                }

                // Clone and replace buttons to remove old event listeners
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

                const newCancelBtn = cancelBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                const close = () => modal.classList.remove('active');
                
                newConfirmBtn.addEventListener('click', () => {
                    close();
                    if (onConfirm) onConfirm();
                });

                newCancelBtn.addEventListener('click', close);
            }
            
            getMoodText(moodValue) {
                const moods = { 1: "Psyched", 2: "Optimistic", 3: "Focused", 4: "Ready", 5: "Composed", 6: "Neutral", 7: "Apathetic", 8: "Frustrated", 9: "Lethargic", 10: "Exhausted" };
                return moods[moodValue] || "Unknown";
            }
            
            createWeeklyTrendChart() {
                const ctx = document.getElementById('weeklyTrendChart').getContext('2d');
                const canvas = document.getElementById('weeklyTrendChart');
                const noDataMsg = document.getElementById('noDataMessage');
                
                if (this.weeklyChart) {
                    this.weeklyChart.destroy();
                }

                const sortedDates = Object.keys(this.trainingData).sort((a, b) => new Date(a) - new Date(b)).slice(-7);
                
                if (sortedDates.length === 0) {
                    // Hide canvas and show message
                    canvas.style.display = 'none';
                    noDataMsg.style.display = 'flex';
                    return;
                }
                
                // Show canvas and hide message
                canvas.style.display = 'block';
                noDataMsg.style.display = 'none';

                const labels = sortedDates.map(date => new Date(date + 'T12:00:00').toLocaleDateString(undefined, { month: 'short', day: 'numeric' }));
                const readinessData = sortedDates.map(date => this.trainingData[date].readiness);
                const stressData = sortedDates.map(date => this.trainingData[date].stress);
                const sleepData = sortedDates.map(date => this.trainingData[date].sleepQuality);

                this.weeklyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Readiness Score',
                            data: readinessData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Stress Level',
                            data: stressData,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Sleep Quality',
                            data: sleepData,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Last 7 Days Trend',
                                font: { size: 18, family: "'Segoe UI'" },
                                color: '#2c3e50',
                                padding: { bottom: 20 }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10,
                                grid: { color: '#ecf0f1' }
                            },
                            x: {
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
        }

        // --- GLOBAL HELPERS & INITIALIZATION ---
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new MultiDayTracker();
            // Assign methods to global scope for inline event handlers
            window.app = app; 
        });

         // These functions can now be removed from the global scope as they are handled by the app instance.
        function validateNumericInput(el, min, max) {
            if (parseFloat(el.value) > max) el.value = max;
            // Do not set to min if below, allows user to clear the field.
        };

        function isNumberKey(evt) {
            const charCode = (evt.which) ? evt.which : evt.keyCode;
            // Allow backspace, decimal point, and numbers
            if (charCode > 31 && (charCode < 48 || charCode > 57) && charCode !== 46) {
                return false;
            }
            return true;
        };

        function isWholeNumberKey(evt) {
            const charCode = (evt.which) ? evt.which : evt.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                return false;
            }
            return true;
        };

    </script>
</body>
</html>